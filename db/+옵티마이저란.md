# +옵티마이저란?

# 옵티마이저란?

- DBMS 내부 엔진으로 - SQL 을 가장 빠르고 효율적으로 수행할 수 있는 최적(최저비용)의 처리 경로를 생성해주는 것이다.
- 사용자가 SQL 로 결과를 요구하면 , 이를 생성하는데 필요한 처리 경로는 DBMS 내장된 옵티마이저가 자동으로 생성해 준다.

# 옵티마이저 종류

## 규칙 기반 옵티마이저(RBO)

- 사전에 정해 놓은 규칙에 따라 실행된다.
- 실행속도가 빠른 순으로 규칙을 먼저 세워두고 우선순위가 앞서는 방법을 채택하는 방식
- 오라클 8 이전에 기본으로 설정된 옵티마이저 이다.
    - ORACLE 의 규칙기반 옵티마이저 순위이며 숫자가 낮은 게 우선 순위가 높다.

        1. Single row by rowid

        2. Single row by clusterjoin

        3. Single row by hash cluster key with unique or primary key

        4. Single row by unique or primary key

        5. Cluster join

        6. Hash Cluster key

        7. Indexed cluster key

        8. Composite index

        9. Single column index

        10. Bounded range search on indexed columns

        11. Unbounded range search on indexed columns

        12. Sort merge join

        13. MAX or MIN of indexed column

        14. ORDER BY on indexed column

        15. Full table scan

- 규칙 기반 옵티마이저는 느려서 사용하지 않는다.

## 비용 기반 옵티마이저

- 최근에 많이 사용하는 옵티마이저 방식이며 오라클 10 이후 버전부터 공식적으로 비용 기반 옵티마이저를 사용한다.
- 비용 기반 옵티마이저는 옵티마이저에서 실행계획을 세운 뒤(최대 2천개) 비용이 최소한으로 나온 실행 계획을 수행합니다.
- 비용 기반 옵티마이저는 비용을 예측하려고 규칙 기반 옵티마이저가 사용하지 않는 테이블, 인덱스, 칼럽 등 다양한 객체 통계정보와 시스템 통계정보를 이용합니다.
    - 통계 정보가 없으면 비효율적인 실행계획을 생성할 수 있으므로, 정확한 통계정보를 유지하는것이 중요합니다.

### 통계 정보

- 비용 기반 옵티마이저에서 가장 중요한 것은 통계 정보 이다.
- 예를 들어 1억건의 레코드가 갱신되지 않아 10만건으로 보이고 있다면 옵티마이저가 실행시 인덱스 레인지 스캔이 아니라 풀 스캔을 해 버릴 수도 있다. 0.1초 걸릴게 1시간이 소요 될 수도 있다는 것이다.
    - Oracle DBMS 같은 경우 통계 정보가 정적이고 수집에 많은 시간이 소요되기 때문에 통계 정보만 따로 백업하기도 한다.

### MySQL 통계 정보

- MySQL 에서 관리되는 통계 정보는 대략의 레코드 건수와 인덱스의 유니크한 값의 갯수 정보가 다이다.
- 대신 MySql 에서 통계정보는 사용자가 잘 알아채지 못하는 순간순간 자동으로 변경되며 동적이다.

    (MySQL 에서는 레코드 건수가 작을 때 통계 정보가 부정확 한 경우가 많다. 그때는 ANALYZE 명령을 통해 갱신해야 될 수도 있다 - 주로 개발용 MySQL 에서 자주 발생)

- + ANALYZE 를 실행하는 동안 MyISAM 테이블은 읽기는 가능하지만 쓰기는 안된다.
    - InnoDB 테이블은 읽기 쓰기 모두 불가능하므로 서비스도중에는 사용하지 말자.
    - ++ MyISAM 테이블의 ANALYZE 는 정확한 키값 분포도를 위해 인덱스 전체를 스캔한다 - 그래서 많은 시간이 소요 된다.
    - InnoDB 테이블은 인덱스 페이지 중에서 8개 정도만 랜덤하게 선택해서 분석하고 그 결과를 인덱스의 통계 정보로 갱신한다.(5.1.38 버전 이후에서는 8개 이상 설정이 가능하지만 3배는 넘지 않도록 하자)

### 마치며

- 옵티마이저같은경우 DBMS 에서 매우 중요한 부분이고 내부 동작 과정을 다 설명하려면 양이 어마어마하다 - 일단 개념을 정리하고 나중에 좀 더 자세히 정리해 보도록 하자.